cmake_minimum_required(VERSION 3.16)
project(higgsr_ros)

# C++17 í‘œì¤€ ì‚¬ìš©
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# ===================================================================
# 1. ROS ë° ê¸°íƒ€ ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì°¾ê¸°
# ===================================================================

# pybind11, PCL ë“± ì™¸ë¶€ íŒ¨í‚¤ì§€ì—ì„œ ë°œìƒí•˜ëŠ” ëª¨ë“  ê°œë°œììš©(dev) ê²½ê³ ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
set(CMAKE_SUPPRESS_DEVELOPER_WARNINGS TRUE)

find_package(ament_cmake_python REQUIRED)
find_package(pybind11 REQUIRED)
find_package(Eigen3 REQUIRED)
find_package(PCL REQUIRED)

# ğŸš€ OpenMP for ë©€í‹°ìŠ¤ë ˆë“œ C++ ê°€ì†í™”
find_package(OpenMP REQUIRED)

# Python ì‹¤í–‰íŒŒì¼ ì°¾ê¸° (ë²„ì „ ê°ì§€ìš©)
find_package(Python3 REQUIRED COMPONENTS Interpreter)

# ROS 2 Python ì˜ì¡´ì„±
find_package(rclpy REQUIRED)
find_package(sensor_msgs REQUIRED)
find_package(geometry_msgs REQUIRED)
find_package(nav_msgs REQUIRED)
find_package(std_msgs REQUIRED)
find_package(visualization_msgs REQUIRED)
find_package(tf2_ros REQUIRED)
find_package(tf2_py REQUIRED)
find_package(higgsr_interface REQUIRED)

# Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
ament_python_install_package(${PROJECT_NAME})

# Python executable ìŠ¤í¬ë¦½íŠ¸ë“¤ ì„¤ì¹˜
install(PROGRAMS
    higgsr_ros/nodes/higgsr_server_node.py
    higgsr_ros/nodes/lidar_client_node.py
    higgsr_ros/nodes/file_processor_node.py
    higgsr_ros/nodes/file_processor_client_node.py
    higgsr_ros/visualization/visualization_node.py
    higgsr_ros/scripts/test_higgsr_system.py
    higgsr_ros/scripts/test_rviz_visualization.py
    DESTINATION lib/${PROJECT_NAME}
)

# ==========================================================
# 4. C++ í™•ì¥ ëª¨ë“ˆ ë¹Œë“œ
# ==========================================================
set(CPP_SRC_DIR ${CMAKE_CURRENT_SOURCE_DIR}/higgsr_ros/core/cpp_src)
if(EXISTS ${CPP_SRC_DIR}/bindings.cpp)
    message(STATUS "C++ source files found, building extension module...")

    pybind11_add_module(higgsr_core_cpp
        ${CPP_SRC_DIR}/bindings.cpp
        ${CPP_SRC_DIR}/feature_extraction.cpp
        ${CPP_SRC_DIR}/registration.cpp
    )

    target_include_directories(higgsr_core_cpp PUBLIC
        $<BUILD_INTERFACE:${CPP_SRC_DIR}/include>
        $<INSTALL_INTERFACE:include>
        ${Eigen3_INCLUDE_DIRS}
        ${PCL_INCLUDE_DIRS}
    )

    target_link_libraries(higgsr_core_cpp PUBLIC
        Eigen3::Eigen
        ${PCL_LIBRARIES}
        OpenMP::OpenMP_CXX
    )

    # Python ë²„ì „ì— ë”°ë¥¸ ë™ì  ê²½ë¡œ ì„¤ì •
    execute_process(
        COMMAND ${Python3_EXECUTABLE} -c "import sysconfig; print(sysconfig.get_python_version())"
        OUTPUT_VARIABLE PYTHON_VERSION
        OUTPUT_STRIP_TRAILING_WHITESPACE
    )
    
    install(TARGETS higgsr_core_cpp
        DESTINATION "lib/python${PYTHON_VERSION}/site-packages/${PROJECT_NAME}/core"
    )

    set(CPP_MODULE_BUILT TRUE)
    message(STATUS "C++ extension module configuration complete")
else()
    set(CPP_MODULE_BUILT FALSE)
    message(STATUS "C++ source files not found, Python-only build")
endif()

# ===================================================================
# 5. ê¸°íƒ€ ìì› ë° ì„¤ì • íŒŒì¼ ì„¤ì¹˜ (ìˆ˜ì • ì—†ìŒ)
# ===================================================================
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/config)
    install(DIRECTORY config/ DESTINATION share/${PROJECT_NAME}/config)
endif()
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/resource)
    install(DIRECTORY resource/ DESTINATION share/ament_index/resource_index/packages)
endif()
install(FILES package.xml DESTINATION share/${PROJECT_NAME})

# í…ŒìŠ¤íŠ¸ ì„¤ì •
if(BUILD_TESTING)
  find_package(ament_lint_auto REQUIRED)
  ament_lint_auto_find_test_dependencies()
endif()

# ament íŒ¨í‚¤ì§€ ì™„ë£Œ
ament_package()
